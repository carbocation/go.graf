{{ define "title" }}{{.Tree.Title}}{{ end }}

{{ define "scripts" }}
<script src="/static/js/template.js"></script>
<script>
$(document).ready(function(){
	var getParentId = function(item){
		return ($(item).closest("div.entry")[0].id).split(/_/)[1]
	};
	
	$(".reply").on("click", function(event){
		app.replaceTemplate("ReplyTemplate", {parent_id: getParentId(this)}, "active_"+getParentId(this));
	});
	
	$(document).on("click", ".clear_active_controls", {}, function(event){
		event.preventDefault();
		
		app.replaceTemplate("BlankTemplate", {}, "active_" + getParentId(this));
	});
	
	$(document).on("click", ".vote", {}, function(event){
		event.preventDefault();
		
		var parentId = getParentId(this);
		var voteEl = this
		
		var submission = {entryId: parentId};
		
		//Send the right kind of vote
		if ($(this).hasClass('active')) {
			console.log("Un-vote for " + submission.entryId);
			submission.vote = 'unvote';
		} else if ($(this).hasClass('upvote')) {
			console.log("Upvote for " + submission.entryId);
			submission.vote = 'upvote';
		} else {
			console.log("Downvote for " + submission.entryId);
			submission.vote = 'downvote';
		}
		
		$.ajax({
			url: "{{ reverse "postVote" }}", 
			type: "POST",
			data: submission,
		}).done(function(msg) {
	    	console.log(msg);
	    	
	    	//Update coloring
			$(voteEl).siblings().removeClass("active");
	    	if ($(voteEl).hasClass('active')) {
	    		$(voteEl).removeClass("active");
	    	} else {
				$(voteEl).addClass("active");
	    	}
    	})
	    .fail(function(msg){ console.log(msg.status + ": " + msg.responseText); });
		
	});
	
	$(document).on("submit", "form.reply", {}, function(event){
		event.preventDefault();
		
		var parentId = getParentId(this);
		var submission = $(this).serializeArray();
		
		console.log("Parent id is: "+parentId)
		
		$.ajax({
			url: "{{ reverse "postThread" }}", 
			type: "POST",
			data: submission,
		}).done(function(msg) {
			$("#message_"+parentId).append("<p class=\"text-info\">"+msg+"</p>")
	    	console.log(msg);
			
			{{/*TODO(james) ignore the response and let websockets kick the message back*/}}
	    	$("#children_"+parentId).append(msg)
	    	app.replaceTemplate("BlankTemplate", {}, "active_" + parentId);
    	})
	    .fail(function(msg){ console.log(msg.status + ": " + msg.responseText); });
	    //.always(function(msg) { console.log(msg); });
	});
	
	$(".appender").on("click", function(event){
		parentId = $(this).closest("div.entry")[0].id
		
		app.appendTemplate("ItemTemplate", {id: "id", title: "name"}, parentId)
	});
});
</script>
{{end}}


{{ define "content" }}
{{if .Tree}}
    <div class="entry" id="entry_{{.Tree.Id}}">
		{{with .Tree}}
			<h1>
			
			<span class="vote upvote {{if .UserVote.Upvote}}active{{end}}">△</span>
			{{if .Url}}
				<a href="{{.Body}}">{{.Title}}</a>
			{{else}}
				{{.Title}}
			{{end}}
			<span class="vote downvote {{if .UserVote.Downvote}}active{{end}}">▽</span>
			</h1>
			
			<p class="lead">{{.Body}}</p>
			<br />
			<div class="active_messages" id="message_{{.Id}}"></div>
			<ul class="inline">
				<li>By {{.AuthorHandle}}</li>
				<li>{{.Points}} {{if eq .Points 1}}Point{{else}}Points{{end}}</li>
				<li>Value: {{.Score}}</li>
				<li><a class="reply">Reply</a></li>
				{{/* TODO(james)
				<li><a href="edit">Edit</a></li>
				<li>&nbsp;</li>
				<li><a href="delete">Delete</a></li>
				*/}}
			</ul>
			<div class="active_controls" id="active_{{.Id}}"></div>
		{{end}}
		<div class="children" id="children_{{.Tree.Id}}">
			{{template "tree" mapfn "User" .User "Tree" .Tree.Child "Color" false}}
		</div>
    </div>
    {{template "_jsTemplates" .}}
{{ else }}
	<p class="text-error">The requested post is unavailable.</p>
{{end}}
{{end}}


{{define "tree"}}
{{if .Tree}}
	<div class="entry nested color{{.Color}}" id="entry_{{.Tree.Id}}">
		{{with .Tree}}
			{{.Body}}
			<br />
			<div class="active_messages" id="message_{{.Id}}"></div>
			<ul class="inline">
				<li><span class="vote upvote {{if .UserVote.Upvote}}active{{end}}">▲</span> By {{.AuthorHandle}} <span class="vote downvote {{if .UserVote.Downvote}}active{{end}}">▼</span></li>
				<li>{{.Points}} {{if eq .Points 1 -1}}Point{{else}}Points{{end}}</li>
				<li>Value: {{.Score}}</li>
				<li>&nbsp;</li>
				<li><a class="reply">Reply</a></li>
				<li><a href="/thread/{{.Id}}">Permalink</a></li>
				{{/* TODO(james)
				<li><a href="edit">Edit</a></li>
				<li>&nbsp;</li>
				<li><a href="delete">Delete</a></li>
				*/}}
			</ul>
			{{/* 
				Messages holds things of which there can only be one.
				For example, you can only get one 'reply' box when 
				you click Reply; you can't get several to stack up.
			*/}} 
			<div class="active_controls" id="active_{{.Id}}"></div>
		{{end}}
		<div class="children" id="children_{{.Tree.Id}}">
	        {{template "tree" mapfn "User" .User "Tree" .Tree.Child "Color" (.Color | not) }}
		</div>
	</div>
    {{template "tree" mapfn "User" .User "Tree" .Tree.Sibling "Color" .Color }}
{{end}}
{{end}}